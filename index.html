<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>A1/A2 è»Šç¦æŒ‡æ¨™</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 30px; }
    h1 { margin-bottom: 10px; }
    h2 { margin-top: 30px; color: #333; }
    .indicator { margin-bottom: 15px; font-size: 18px; }
    .up { color: red; font-weight: bold; }
    .down { color: green; font-weight: bold; }
    .note { margin-top: 30px; font-size: 14px; color: gray; }
    .warning { color: gray; margin-top: 10px; }
  </style>
</head>
<body>
  <h1>A1/A2 é¡è»Šç¦äº‹æ•…çµ±è¨ˆæŒ‡æ¨™</h1>

  <!-- A1 -->
  <h2>ğŸ”µ A1 é¡</h2>
  <div id="A1_lastMonth" class="indicator">è®€å–ä¸­...</div>
  <div id="A1_prevYear" class="indicator">è®€å–ä¸­...</div>
  <div id="A1_prevMonth" class="indicator">è®€å–ä¸­...</div>

  <!-- A2 -->
  <h2>ğŸŸ  A2 é¡</h2>
  <div id="A2_lastMonth" class="indicator">è®€å–ä¸­...</div>
  <div id="A2_prevYear" class="indicator">è®€å–ä¸­...</div>
  <div id="A2_prevMonth" class="indicator">è®€å–ä¸­...</div>
  <div id="A2_warning" class="warning"></div>

  <div class="note" id="note"></div>

  <script>
    // ğŸ¯ è¨ˆç®—ä»Šå¤©çš„å‰ä¸€å€‹æœˆ
    function getTargetMonth() {
      const today = new Date();
      let year = today.getFullYear();
      let month = today.getMonth(); // getMonth() 0=1æœˆ â†’ é€™å°±æ˜¯ã€Œä¸Šå€‹æœˆã€
      if (month === 0) { // å¦‚æœä»Šå¤©æ˜¯1æœˆï¼Œå¾€å‰å°±æ˜¯å»å¹´12æœˆ
        month = 12;
        year -= 1;
      }
      return { year, month };
    }

    // æ‰¾ã€ŒåŒå¹´å‰ä¸€å€‹æœˆã€
    function getPrevMonth(year, month, data) {
      let prevYear = year;
      let prevMonth = month - 1;
      if (prevMonth === 0) {
        prevMonth = 12;
        prevYear -= 1;
      }
      return data.find(d => d.year === prevYear && d.month === prevMonth) || null;
    }

    // æ‰¾ã€Œå‰ä¸€å¹´åŒæœˆã€
    function getPrevYearSameMonth(year, month, data) {
      return data.find(d => d.year === year - 1 && d.month === month) || null;
    }

    // æ ¼å¼åŒ–å¢æ¸›ç‡ + ç®­é ­
    function formatChange(curr, prev) {
      if (!prev || prev.count === 0) return "âš  ç„¡è³‡æ–™";
      const diff = curr.count - prev.count;
      const rate = ((diff) / prev.count * 100).toFixed(1);
      if (diff > 0) return `<span class="up">â–² ${rate}%</span>`;
      if (diff < 0) return `<span class="down">â–¼ ${rate}%</span>`;
      return `<span>0%</span>`;
    }

    // ä¸»ç¨‹å¼
    function processData(raw, prefix) {
      const data = [];
      raw.forEach(d => {
        const year = parseInt((d["ç™¼ç”Ÿå¹´åº¦"] || "").toString().trim(), 10);
        const month = parseInt((d["ç™¼ç”Ÿæœˆä»½"] || "").toString().trim(), 10);
        const count = parseInt((d["ä»¶æ•¸"] || "").toString().trim(), 10);
        if (isNaN(year) || isNaN(month) || isNaN(count)) return;
        data.push({ year, month, count });
      });

      data.sort((a,b) => (a.year*100+a.month) - (b.year*100+b.month));

      const target = getTargetMonth();
      const latest = data.find(d => d.year === target.year && d.month === target.month);

      if (!latest) {
        document.getElementById(`${prefix}_lastMonth`).innerHTML = `âš  ${target.year}/${target.month} æ²’æœ‰è³‡æ–™`;
        return;
      }

      const prevMonth = getPrevMonth(latest.year, latest.month, data);
      const prevYearSameMonth = getPrevYearSameMonth(latest.year, latest.month, data);

      document.getElementById(`${prefix}_lastMonth`).innerHTML =
        `ä¸Šå€‹æœˆï¼ˆ${latest.year}/${latest.month}ï¼‰ï¼š<b>${latest.count}</b> ä»¶`;

      document.getElementById(`${prefix}_prevYear`).innerHTML =
        prevYearSameMonth
          ? `å‰ä¸€å¹´åŒæœˆï¼ˆ${prevYearSameMonth.year}/${prevYearSameMonth.month}ï¼‰ï¼š<b>${prevYearSameMonth.count}</b> ä»¶ï¼Œå¢æ¸›ç‡ï¼š${formatChange(latest, prevYearSameMonth)}`
          : `å‰ä¸€å¹´åŒæœˆï¼šâš  ç„¡è³‡æ–™`;

      document.getElementById(`${prefix}_prevMonth`).innerHTML =
        prevMonth
          ? `åŒå¹´å‰ä¸€æœˆï¼ˆ${prevMonth.year}/${prevMonth.month}ï¼‰ï¼š<b>${prevMonth.count}</b> ä»¶ï¼Œå¢æ¸›ç‡ï¼š${formatChange(latest, prevMonth)}`
          : `åŒå¹´å‰ä¸€æœˆï¼šâš  ç„¡è³‡æ–™`;

      // âš  è³‡æ–™ç•°å¸¸æé†’ï¼ˆåªåšåœ¨ A2ï¼Œæª¢æŸ¥æœ€è¿‘ 12 å€‹æœˆï¼‰
      if (prefix === "A2") {
        const targetIndex = data.findIndex(d => d.year === target.year && d.month === target.month);
        const recent = data.slice(Math.max(0, targetIndex - 11), targetIndex + 1);
        const warnings = recent
          .filter(d => d.count < 1000)
          .map(d => `âš ï¸ æ³¨æ„ï¼š${d.year} å¹´ ${d.month} æœˆ A2 é¡äº‹æ•…ä»¶æ•¸ï¼ˆ${d.count}ï¼‰å¯èƒ½å› è³‡æ–™æœªå®Œæ•´ä¸Šå‚³è€Œåä½ã€‚`);
        document.getElementById("A2_warning").innerHTML = warnings.join("<br>");
      }
    }

    // é¡¯ç¤ºåŸºæº–æœˆä»½
    const t = getTargetMonth();
    document.getElementById("note").innerText = `ğŸ“… æœ¬é çµ±è¨ˆåŸºæº–ï¼š${t.year}/${t.month}`;

    // è®€å– A1_summary.csv
    Papa.parse("./A1_summary.csv", {
      download: true,
      header: true,
      complete: function(results) {
        processData(results.data, "A1");
      }
    });

    // è®€å– A2_summary.csv
    Papa.parse("./A2_summary.csv", {
      download: true,
      header: true,
      complete: function(results) {
        processData(results.data, "A2");
      }
    });
  </script>
</body>
</html>
