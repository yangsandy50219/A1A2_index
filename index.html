<!DOCTYPE html>
<html lang="zh-TW">

<head>
  <meta charset="UTF-8">
  <title>å°å—å¸‚ A1 / A2 è»Šç¦äº‹æ•…æŒ‡æ¨™</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 30px;
    }

    h1 {
      text-align: center;
      margin-bottom: 20px;
    }

    .container {
      display: flex;
      gap: 40px;
      justify-content: center;
      flex-wrap: wrap;
    }

    .panel {
      flex: 1 1 420px;
      max-width: 600px;
      border: 1px solid #ccc;
      border-radius: 8px;
      padding: 20px;
    }

    h2 {
      margin-top: 0;
    }

    .indicator {
      margin: 14px 0;
      font-size: 18px;
      line-height: 1.6;
    }

    .up {
      color: red;
      font-weight: bold;
    }

    .down {
      color: green;
      font-weight: bold;
    }

    .note {
      margin-top: 20px;
      font-size: 14px;
      color: gray;
      text-align: center;
    }

    .warning {
      margin-top: 10px;
      color: gray;
      font-size: 15px;
    }

    .badge {
      display: inline-block;
      padding: 2px 10px;
      border-radius: 999px;
      font-weight: 700;
      color: #fff;
      margin-left: 6px;
      font-size: 16px;
    }

    /* ç´…åº• */
    .badge.up {
      background: rgba(211, 47, 47, 0.85);
    }

    /* ç¶ åº• */
    .badge.down {
      background: rgba(56, 142, 60, 0.85);
    }

    /* ç°åº• */
    .badge.zero {
      background: rgba(120, 120, 120, 0.8);
    }

    /* + ç´…è‰² */
    .delta-up {
      color: #d32f2f;
      font-weight: bold;
    }

    /* - ç¶ è‰² */
    .delta-down {
      color: #388e3c;
      font-weight: bold;
    }

    /* +0 ç°è‰² */
    .delta-zero {
      color: #777;
      font-weight: bold;
    }

    /* ===== i æç¤ºéˆ•ï¼ˆåŸæœ¬ç‰ˆæœ¬ï¼‰ ===== */
    .info-icon {
      position: relative;
      top: -2px;
      /* â­ åªå¾®èª¿ï¼Œä¸è¦å¤§å¹…ä½ç§» */
      margin-right: 2px;
    }

    .info-btn {
      position: relative;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      margin-left: 8px;

      background: #ffffff;
      color: rgb(71, 134, 235);
      padding: 6px 10px;
      border-radius: 999px;

      font-size: 18px;
      /* â­ i æœ¬èº«ä¹Ÿç¨å¾®æ”¾å¤§ */
      font-weight: bold;
      cursor: pointer;
      user-select: none;
    }

    /* ğŸ‘ˆ ä¸€é–‹å§‹åªé¡¯ç¤º i */
    .info-text {
      display: none;

      font-size: 16px;
      /* â­ æ”¾å¤§ */
      font-weight: 600;

      padding: 4px 10px;
      border-radius: 12px;

    }

    /* ğŸ‘ˆ æ»‘ä¸Šå»æ‰é¡¯ç¤ºã€Œä»€éº¼æ˜¯ A1/A2 é¡äº‹æ•…ï¼Ÿã€ */
    .info-btn:hover .info-text {
      display: inline;
    }

    /* ===== èªªæ˜æ¡† ===== */
    .info-btn .tooltip {
      visibility: hidden;
      opacity: 0;

      width: 360px;
      background-color: rgba(0, 0, 0, 0.75);
      color: #fff;
      border-radius: 12px;
      padding: 16px;

      position: absolute;
      top: calc(100% + 8px);
      /* â­ å‡ºç¾åœ¨æ•´æ’ä¸‹æ–¹ */
      left: 0;
      /* â­ èˆ‡ i å°é½Š */
      transform: none;
      /* â­ æ‹¿æ‰ translateY */

      z-index: 10;

      font-size: 16px;
      /* ç¨å¾®å†å¤§ä¸€é» */
      line-height: 1.7;

      transition: opacity .2s ease;
    }

    /* ğŸ‘ˆ æ»‘åˆ°æ•´å€‹ info-btn æ‰é¡¯ç¤ºèªªæ˜æ¡† */
    .info-btn:hover .tooltip {
      visibility: visible;
      opacity: 1;
    }
  </style>
</head>

<body>
  <h1>å°å—å¸‚ A1 / A2 é¡è»Šç¦äº‹æ•…æŒ‡æ¨™</h1>

  <div class="info-btn">
    <span class="info-icon">â“˜</span>
    <span class="info-text">ä»€éº¼æ˜¯ A1/A2 é¡è»Šç¦ï¼Ÿ</span>
    <div class="tooltip">
      <strong>A1é¡ï¼š</strong>è»Šç¦ç•¶ä¸‹æˆ–è»Šç¦ç™¼ç”Ÿ 24 å°æ™‚å…§æœ‰äººæ­»äº¡ã€‚<br>
      <strong>A2é¡ï¼š</strong>è»Šç¦æœ‰äººå“¡å—å‚·æˆ–è»Šç¦ç™¼ç”Ÿ 24 å°æ™‚å¾Œæœ‰äººæ­»äº¡ã€‚<br>
    </div>
  </div>


  <div class="container">
    <!-- A1 -->
    <div class="panel">
      <h2>ğŸ”µ A1 é¡ï¼ˆæ­»äº¡äº‹æ•…ï¼‰</h2>
      <div id="A1_lastMonth" class="indicator">è®€å–ä¸­...</div>
      <div id="A1_prev3yAvg" class="indicator">è®€å–ä¸­...</div>
      <div id="A1_prevMonth" class="indicator">è®€å–ä¸­...</div>
    </div>

    <!-- A2 -->
    <div class="panel">
      <h2>ğŸŸ  A2 é¡ï¼ˆå—å‚·äº‹æ•…ï¼‰</h2>
      <div id="A2_lastMonth" class="indicator">è®€å–ä¸­...</div>
      <div id="A2_prev3yAvg" class="indicator">è®€å–ä¸­...</div>
      <div id="A2_prevMonth" class="indicator">è®€å–ä¸­...</div>
      <div id="A2_warning" class="warning"></div>
    </div>
  </div>

  <div class="note" id="note"></div>

  <script>
    /* ===== å–å‰ä¸‰å€‹æœˆ ===== */
    const OFFSET = 3; // â­ é€™è£¡æ”¹æˆ 1=å‰1å€‹æœˆã€2=å‰2å€‹æœˆã€3=å‰3å€‹æœˆ...
    function getTargetMonth(offset = OFFSET) {
      const d = new Date();
      d.setDate(1);
      d.setMonth(d.getMonth() - offset);
      return { year: d.getFullYear(), month: d.getMonth() + 1 };
    }

    function findRecord(year, month, data) {
      return data.find(d => d.year === year && d.month === month) || null;
    }

    function getPrevMonth(year, month, data) {
      let y = year, m = month - 1;
      if (m === 0) { m = 12; y -= 1; }
      return findRecord(y, m, data);
    }

    function getPrev3yAvg(year, month, data) {
      const years = [year - 1, year - 2, year - 3];
      const vals = data
        .filter(d => d.month === month && years.includes(d.year))
        .map(d => d.count)
        .filter(v => Number.isFinite(v));

      if (!vals.length) return null;
      return vals.reduce((a, b) => a + b, 0) / vals.length;
    }

    function formatDeltaColored(curr, base) {
      if (!Number.isFinite(base)) return "";
      const diff = curr - base;

      // å–åˆ°å°æ•¸ 1 ä½
      const diffText = diff.toFixed(1);

      if (diff > 0) return `<span class="delta-up">+${diffText}</span>`;
      if (diff < 0) return `<span class="delta-down">${diffText}</span>`;

      // âœ… diff = 0 çš„æƒ…æ³ï¼š+0.0 ç”¨ç°è‰²
      return `<span class="delta-zero">+0.0</span>`;
    }


    // âœ… å‰ä¸€æœˆï¼šä¿ç•™ä½ ä¹‹å‰è¦çš„ã€Œè† å›Šç™¾åˆ†æ¯”ã€
    function formatChangeBadge(curr, prev) {
      if (!Number.isFinite(prev) || prev === 0) return `<span class="badge zero">ç„¡è³‡æ–™</span>`;
      const diff = curr - prev;
      const rate = (diff / prev * 100);
      const rateText = `${Math.abs(rate).toFixed(1)}%`;

      if (diff > 0) return `<span class="badge up">â–² ${rateText}</span>`;
      if (diff < 0) return `<span class="badge down">â–¼ ${rateText}</span>`;
      return `<span class="badge zero">0%</span>`;
    }

    // âœ… ä¸‰å‰å¹´åŒæœˆå¹³å‡ï¼šä½ è¦çš„ç´”æ–‡å­—ç™¾åˆ†æ¯”ï¼ˆä¸è¦â–²â–¼ã€ä¸è¦è† å›Šï¼‰
    function formatRateText(curr, base) {
      if (!Number.isFinite(base) || base === 0) return "âš  ç„¡è³‡æ–™";
      const diff = curr - base;
      const rate = (diff / base * 100);
      // ä½ ç¤ºä¾‹æ˜¯ 0%ï¼ˆå…¶å¯¦ä¹Ÿå¯ä»¥é¡¯ç¤º 0.0% ä½ çœ‹è¦ä¸è¦ï¼‰
      return `${rate.toFixed(1)}%`;
    }

    function render(prefix, data) {
      const target = getTargetMonth(OFFSET);
      const latest = findRecord(target.year, target.month, data);

      if (!latest) {
        document.getElementById(`${prefix}_lastMonth`).innerHTML = "âš  ç„¡è³‡æ–™";
        document.getElementById(`${prefix}_prev3yAvg`).innerHTML = "âš  ç„¡è³‡æ–™";
        document.getElementById(`${prefix}_prevMonth`).innerHTML = "âš  ç„¡è³‡æ–™";
        return;
      }

      const curr = latest.count;

      // å‰ä¸€æœˆ
      const prev = getPrevMonth(latest.year, latest.month, data);
      const prevCount = prev ? prev.count : NaN;

      // å‰ä¸‰å¹´åŒæœˆå¹³å‡
      const avg3y = getPrev3yAvg(latest.year, latest.month, data); // ä½ åŸæœ¬å›å‚³ avg (number) æˆ– null

      // 1) çµ±è¨ˆæœˆä»½
      document.getElementById(`${prefix}_lastMonth`).innerHTML =
        `çµ±è¨ˆæœˆä»½ï¼ˆ${latest.year}/${latest.month}ï¼‰ï¼š<b>${curr}</b> ä»¶`;

      // 2) âœ… ä¸‰å‰å¹´åŒæœˆå¹³å‡ï¼ˆç…§ä½ æŒ‡å®šæ ¼å¼ï¼‰
      if (avg3y !== null && Number.isFinite(avg3y)) {
        const y1 = latest.year - 3;
        const y2 = latest.year - 1;

        document.getElementById(`${prefix}_prev3yAvg`).innerHTML =
          `å‰ä¸‰å¹´åŒæœˆå¹³å‡ï¼ˆ${y1}~${y2}ï¼šå¹³å‡ <b>${formatAvg(avg3y)}</b> ä»¶ï¼‰ ` +
          `${formatDeltaColored(curr, avg3y)}ï¼š${formatChangeBadge(curr, avg3y)}`;
      } else {
        document.getElementById(`${prefix}_prev3yAvg`).innerHTML =
          `å‰ä¸‰å¹´åŒæœˆå¹³å‡ï¼šâš  ç„¡è³‡æ–™`;
      }


      // 3) å‰ä¸€æœˆæ¯”è¼ƒï¼ˆå« +10 èˆ‡è† å›Šç™¾åˆ†æ¯”ï¼‰
      document.getElementById(`${prefix}_prevMonth`).innerHTML =
        prev
          ? `èˆ‡å‰ä¸€æœˆï¼ˆ${prev.year}/${prev.month}ï¼š<b>${prevCount}</b> ä»¶ï¼‰æ¯”è¼ƒ ` +
          `${formatDeltaColored(curr, prevCount)}ï¼š${formatChangeBadge(curr, prevCount)}`
          : `èˆ‡å‰ä¸€æœˆæ¯”è¼ƒï¼šâš  ç„¡è³‡æ–™`;

    }

    //ã€Œå¢æ¸›å¤šå°‘ã€ï¼šå– 1 ä½å°æ•¸ + ä¸Šè‰²
    function formatDeltaColored(curr, base) {
      if (!Number.isFinite(base)) return "";

      // â­ é—œéµï¼šå…ˆå››æ¨äº”å…¥åˆ° 1 ä½
      const diff = +(curr - base).toFixed(1);

      if (diff > 0) {
        return `<span class="delta-up">+${diff.toFixed(1)}</span>`;
      }

      if (diff < 0) {
        return `<span class="delta-down">${diff.toFixed(1)}</span>`;
      }

      // â­ çœŸçš„ç­‰æ–¼ 0 æ‰é€²ä¾†
      return `<span class="delta-zero">+0.0</span>`;
    }

    //ã€Œç™¾åˆ†æ¯” badgeï¼ˆé€šç”¨ç‰ˆï¼Œå‰ä¸€æœˆ & ä¸‰å¹´å¹³å‡éƒ½ç”¨ï¼‰ã€
    function formatChangeBadge(curr, base) {
      if (!Number.isFinite(base) || base === 0)
        return `<span class="badge zero">ç„¡è³‡æ–™</span>`;

      const diff = curr - base;
      const rate = (diff / base * 100).toFixed(1);

      if (diff > 0) return `<span class="badge up">â–² ${rate}%</span>`;
      if (diff < 0) return `<span class="badge down">â–¼ ${Math.abs(rate)}%</span>`;
      return `<span class="badge zero">0.0%</span>`;
    }

    //å°å·¥å…·ï¼šé¡¯ç¤ºå¹³å‡å€¼ï¼ˆå›ºå®š 1 ä½ï¼‰
    function formatAvg(v) {
      if (!Number.isFinite(v)) return "ç„¡è³‡æ–™";
      return v.toFixed(1);
    }


    function loadCSV(file, prefix) {
      Papa.parse(file, {
        download: true,
        header: true,
        complete: res => {
          const data = res.data.map(d => ({
            year: parseInt(d["ç™¼ç”Ÿå¹´åº¦"]),
            month: parseInt(d["ç™¼ç”Ÿæœˆä»½"]),
            count: parseInt(d["å°å—å¸‚æ•¸é‡"])
          })).filter(d => Number.isFinite(d.year) && Number.isFinite(d.month));

          data.sort((a, b) => (a.year * 100 + a.month) - (b.year * 100 + b.month));
          render(prefix, data);
        }
      });
    }

    const t = getTargetMonth(OFFSET);
    document.getElementById("note").innerText =
      `ğŸ“… æŒ‡æ¨™çµ±è¨ˆåŸºæº–ï¼š${t.year}/${t.month}`;

    loadCSV("./A1_summary.csv", "A1");
    loadCSV("./A2_summary.csv", "A2");



  </script>
</body>

</html>
